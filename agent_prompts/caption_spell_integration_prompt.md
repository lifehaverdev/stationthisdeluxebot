# TASK: Wire Dataset Captioning via Spell Casting

## Context
StationThis datasets require caption sets generated by *utility spells* (run through `/api/v1/spells/cast`). Intern code introduced a standalone `/captions/generate` path; we are removing that. Caption generation must delegate to our existing spell execution pipeline.

Relevant code entrypoint:
* `src/api/external/spells/spellsApi.js` – exposes `POST /spells/cast` which proxies to internal API.

Frontend (web sandbox):
* `ModsMenuModal.js` currently calls `POST /datasets/:id/captions/generate` – this will be replaced with batched spell casts.
* Each dataset image resides in `dataset.images[]` with stable index order.

## Goals for this assignment
1. **Identify how to tag/identify caption-utility spells** so UI can surface available captioning methods (e.g., "style-caption", "subject-caption"). Avoid magic IDs; prefer metadata (tag `caption` or category `captioning`).
2. **Design API contract** for requesting caption generation against a dataset:
   • Client sends *one* request indicating spell slug/ID, datasetId, optional params.  
   • Backend expands into N `/spells/cast` calls (one per image) or uses internal batching if available.  
   • Successful captions are persisted to the dataset as a new `captionSets` entry: `{ _id, method, captions: [string], createdAt, isDefault }` ensuring `captions[i]` matches `images[i]`.
3. **Error & progress reporting** via existing websocket channels (`captionProgress` in ModsMenuModal). Ensure castIds map back to image idx for incremental UI updates.
4. **Update security & cost accounting** – caption spell cost deducted per image cast.
5. **Migration plan** – remove obsolete `/captions/generate` route, update Docs & ADRs.

## Deliverables
1. ADR detailing caption-via-spell architecture.
2. Updated `spellsApi.js` (or new service) implementing dataset-caption batch cast.
3. Frontend changes to ModsMenuModal to call new endpoint & handle streaming progress.
4. Unit tests for batch caption orchestration.

Use the AGENT COLLABORATION PROTOCOL templates.

---
**Start by exploring `spellsApi.js`, internal spell execution flow, and dataset schema. Outline how to mark captioning spells and draft the batch orchestration endpoint.**
