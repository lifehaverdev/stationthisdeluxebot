## System Overview & Recent Progress

We're continuing to build StationThis, a real-time, creative, cross-platform AI assistant. Our main focus is on user-visible features, developed iteratively with human review. The user experience is paramount, guiding system evolution towards practical, working solutions rather than chasing perfect abstractions. Our development follows a demonstration-first approach, as outlined in `REFACTOR_GENIUS_PLAN.md`. The long-term vision, detailed in `REFACTOR_NORTH_STAR.md`, is a web application with multi-platform AI generation capabilities (image, video, audio), revenue generation through points, and an interactive canvas-based UI. Collaboration between humans and agents is guided by `AGENT_COLLABORATION_PROTOCOL.md`, emphasizing user supervision and live demos. All design artifacts and handoffs are stored in `/vibecode/`.

The system architecture is layered, comprising Core Services (like ComfyUI management, session handling), Platform-Agnostic Logic (e.g., image generation workflows, user settings), Platform Adapters (Telegram, Discord, Web), a comprehensive API Layer (both internal and external), and Entry Points.

A significant architectural decision (ADR-003) has been fully implemented: all access to Noema database collections (User Core, Sessions, Events, Economy, Transactions, Preferences, Generation Outputs) now occurs exclusively through a dedicated Internal API layer (`src/api/internal/`). This centralized approach, with RESTful endpoints for all seven core Noema services, is verified by `scripts/test_internal_api.sh` and ensures consistency, security, and easier maintenance.

We've established a unified `ToolDefinition` format and a `ToolRegistry` (ADR-004). This system manages tools, like ComfyUI workflows, across different services and platforms. The `ToolDefinition` includes `toolId`, `service`, `inputSchema`, `costingModel`, and `platformHints`, powering dynamic command generation in Telegram, UI scaffolding for settings, and cost tracking.

A standardized debit accounting system (ADR-005) is operational. Upon successful completion of a generation, services trigger a debit via the internal economy API (`POST /internal/v1/data/users/:masterAccountId/economy/debit`). The `webhookProcessor.js` calculates the final `costUsd`, updates the `generationRecord`, and issues the debit. `usdCredit` is the canonical currency for AI tasks, and EXP points are also updated post-debit. This flow is live for ComfyUI generations triggered from Telegram.

User settings management has been enhanced (ADR-006) with a `UserSettingsService` and updates to internal APIs for tool parameter preferences. Users can customize default parameters for each tool. The internal API allows fetching a tool's `inputSchema`, listing a user's previously used tools, and deleting preferences. Platform adapters are responsible for merging user input, user preferences, and tool defaults. On Telegram, a multi-level inline keyboard menu for `/settings` (ADR-007) is live, allowing users to navigate their tools, view descriptions, and edit parameters directly.

A decoupled notification system (ADR-001) has been implemented and is fully functional. After `webhookProcessor.js` updates a `generationRecord` (e.g., with completion status and cost), a separate `NotificationDispatcher.js` monitors these records and handles sending notifications, currently via Telegram. The `generationRecord` now tracks notification platform, context, and delivery status (`pending`, `sent`, `failed`), which has resolved issues with repeat notifications.

The Telegram delivery menu for generations has been significantly enhanced (ADR-008). It now offers options to rate a generation (usable by any user in a group chat), hide the menu, view detailed generation info (parameters), tweak parameters (which directs to a pre-filled settings menu), and rerun the generation with a new random seed. The rerun button (`â†»`) on each message interactively displays a press count, updating its own `callback_data` and text, while the overall rerun lineage is tracked separately in the generation's metadata. Debugging for `rerun_gen` callback issues related to dependencies and event logging has been completed.

LoRA trigger word resolution and permission-based prompt substitution (ADR-009) are being actively developed. The system detects trigger words in prompts, substitutes them with the correct `<lora:slug:weight>` syntax, and will enforce access controls. This logic is integrated into `WorkflowsService`. A key UX improvement ensures that users always see their original, untransformed prompt in UI elements like "view info" or "tweak," with the original prompt stored in `generationRecord.metadata.userInputPrompt` and the LoRA-processed version in `generationRecord.requestPayload.input_prompt`. Recent fixes addressed LoRA checkpoint filtering and ensured correct notification context for tweaked/rerun generations.

Cost rate calculation for generations is more robust, determined by looking up a deployment's machine and GPU, mapping to predefined rates, and storing this in the `generationRecord`. API key authentication is also functional, supporting an external endpoint (`GET /api/v1/me/status`) for users to fetch their status (points, EXP, active wallet, live generation tasks), leveraging an internal API key validation sub-system.

Ongoing efforts include continuing to refactor platform adapters and core workflows to consistently use the new internal API endpoints for all Noema data access, moving away from direct database calls. The Telegram UI/UX for tool commands remains a key focus, emphasizing immediate acknowledgments (e.g., message reactions) and the enhanced delivery menu.

Future plans, detailed in `jobs-teams-sprint-plan.md` and ADR-Teams, involve introducing Team-based infrastructure and a Job (multi-step toolchain) system. This will include new services like `TeamService`, `TeamEconomyService`, `JobDefinitionRegistry`, and `JobOrchestrator`. Corresponding database schemas for `teams`, `teamMemberships`, `jobDefinitions`, and `jobRecords` will be added. API handlers and Telegram commands will need to support an execution context (user vs. team), and debit logic will be updated for team balances. The `ToolDefinition` will also gain a more structured `outputSchema` to support job input/output mapping.

A few things to note for upcoming work: we still need to define and implement the mechanism for fetching "most frequently used tools" for the Telegram `/settings` menu. We also need to ensure the Telegram notifier correctly initializes the rerun button's callback data with a count of 0 for new generation messages. Updating test stubs and overall test coverage for these new features, along with continued log refinement and JSDoc for recent services, are important ongoing tasks. For LoRA, implementing the user alert mechanism for denied triggers and policing user-provided LoRA tags are on the horizon.

This summary provides a snapshot of our current system state and development trajectory. 