# HANDOFF: 2025-07-11

## Work Completed
- Implemented robust fallback logic in the `/spend` endpoint: if no deposits are found for `masterAccountId`, the system now looks up the user's primary wallet address and attempts to spend from wallet-based deposits.
- Refactored the contributor rewards logic in `webhookProcessor.js` to use a share-based model:
  - 20% of the generation cost (in points) is distributed among LoRA trainers, spell creators, and (future) base model owners, proportional to their shares.
  - The user is charged the base cost plus the contributor rewards.
  - The generation record is updated with detailed accounting (points spent, contributor rewards, protocol net, reward breakdown).
- Verified correct behavior for both web and telegram clients: points are spent, rewards are distributed (or skipped if no contributors), and no errors occur.
- Updated logs and accounting to reflect the new logic.

## Current State
- All image generation costs are now correctly debited from user wallet-based deposits if present, with fallback from `masterAccountId`.
- Contributor rewards are calculated and distributed according to the new share-based model.
- Generation records and logs accurately reflect all point flows and reward breakdowns.
- No errors or regressions observed in production logs for both web and telegram flows.

## Next Tasks
- Test and verify contributor rewards with actual LoRA and spell usage by other users.
- (Future) Implement base model owner rewards when model ownership metadata is available.
- Continue to monitor logs for any edge cases or regressions.
- Update documentation and onboarding for new contributor reward logic.

## Changes to Plan
- No major deviations from the REFACTOR_GENIUS_PLAN; this work aligns with the planned improvements to wallet-based accounting and incentive distribution.

## Open Questions
- Should any additional contributor types (e.g., workflow authors, pipeline creators) be included in the reward split in the future?
- How should rounding/remainder points be handled if the reward pool does not divide evenly among contributors?
- When should the base model owner reward logic be activated? 