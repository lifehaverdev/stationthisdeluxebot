# HANDOFF: 2025-07-23

## Work Completed
- Conducted end-to-end audit of tool lifecycle covering Telegram (`dynamicCommands.js`), Web sandbox (`toolWindow.js`), dispatcher APIs, `ToolRegistry`, spell execution path, ComfyUI integration, and static ChatGPT tool.
- Identified quick wins, medium, and high-effort refactors ordered by impact on reliability and maintainability.

## Current State
The execution pipeline works but contains duplicated entry points, missing validation, scattered costing logic, and ad-hoc notification handling. These issues complicate upcoming integration of `collectionCook.js` and future platform adapters.

## Next Tasks
### Low Effort / High Benefit (Quick Wins)
1. **Central request helper** – expose one client (e.g. `ExecutionClient.execute()`) used by all front-ends; drop duplicate proxy logic.
2. **Input validation middleware** – enforce `inputSchema` at the dispatcher; reject unknown / wrong-type params.
3. **Fix enum warning** – update `chatgpt.js` category to a validated value (e.g. `interrogate`).
4. **Prompt key normalisation** – always map `prompt`→`input_prompt` before dispatch.
5. **Config constants** – extract hard-coded `/api/v1` URLs into shared config.

### Medium Effort / High Benefit
6. **Single costing module** – centralise GPU cost table + points calculation; inject into dispatcher & cache manager.
7. **Event bus + NotificationDispatcher** – emit `generationUpdated` etc. via one emitter; front-ends subscribe uniformly.

### Medium Effort / Medium Benefit
8. **Improve Telegram tool classification** – rely on `inputSchema` & `platformHints` instead of name heuristics.
9. **Unify caches** – let `workflowCacheManager` own deployments/machines; `ComfyUIService` reads through it.

### High Effort / High Benefit
10. **Contract tests** – end-to-end tests that submit an execution and assert DB + websocket side-effects.
11. **Delivery-mode envelope** – dispatcher returns `{final:boolean, payload}` so UI never inspects `tool.deliveryMode`.

### High Effort / Medium Benefit
12. **Shared credit/points service** – extract pre-execution credit logic into its own service for reuse by future batch jobs.

## Changes to Plan
None yet; tasks align with REFACTOR_GENIUS_PLAN.md North-Star goals.

## Open Questions
- Which upcoming deadline drives `collectionCook.js` rollout?
- Any third-party SLA that constrains refactor sequencing?
- Should costing move to on-chain price oracle later? 