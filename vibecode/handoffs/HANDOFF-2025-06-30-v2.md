# HANDOFF: 2025-06-30 (v2)

## Work Completed
This session involved a complete overhaul of the platform's point-of-sale and credit accounting system. The following major features were implemented:

1.  **Protocol Markup & Referral Rewards:**
    *   A 30% protocol markup is now applied to all user deposits after gas costs.
    *   A 5% referral reward, calculated from the gross deposit value, is credited to the creator of a referral vault. This reward is paid out from the protocol's markup.

2.  **Asset-Based Accounting & Prioritized Spending:**
    *   The legacy aggregate `usdCredit` balance has been decommissioned.
    *   Each deposit (token or NFT) is now tracked as an individual entry in the `credit_ledger` with its own `pointsCredited` and `pointsRemaining`.
    *   A new `/spend` endpoint deducts generation costs from a user's deposits in a prioritized order, spending from deposits with the lowest funding rate first.

3.  **Dynamic Funding Rates for Tokens & NFTs:**
    *   A tiered funding rate system has been introduced to incentivize preferred assets. Rates are applied to the gross deposit value before any other calculations.
    *   NFT deposits are now supported, with credit based on floor prices fetched dynamically from Alchemy's API.
    *   A list of "Trusted NFT Collections" (e.g., Milady, Remilio) receive preferential, boosted funding rates.

4.  **Contributor Rewards System:**
    *   The generation webhook (`webhookProcessor.js`) now uses the new `/spend` endpoint.
    *   After a successful spend, 20% of the points cost is distributed as a reward to the creators of the spells and models used in the generation.
    *   A new `/credit-points` endpoint and corresponding database methods were created to handle these reward payouts.

## Current State
The economic model is now far more robust and aligns with the platform's long-term goals. The system can successfully handle deposits of both tokens and NFTs, apply complex rate and markup logic, and correctly attribute spending and rewards on a per-asset basis. All core debit and credit logic now flows through the new, centralized `credit_ledger` system.

## Next Tasks
- Implement a withdrawal/refund system that allows users to cash out the `pointsRemaining` on their unspent deposits. This should convert points back to the original asset at the locked-in deposit-time price, honoring the funding rate applied.

## Changes to Plan
- All work was completed as part of a major, user-directed refactor of the core economy system.

## Open Questions
- What is the next development priority? Is the withdrawal system the correct focus?
- Should any of the funding rates for tokens or trusted NFTs be adjusted?
- The smart contract ABI may need to be formally updated to include the `NFTDepositRecorded` event that the system now depends on. Should this be scheduled? 