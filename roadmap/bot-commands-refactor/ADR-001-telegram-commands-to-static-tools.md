# ADR-001: Migrate Legacy Telegram Commands to Static Tool Definitions

## Context
The legacy `deluxebot` code-base contains several command modules (`assist.js`, `ffmpeg.js`, `tripo.js`, `speak.js`, `fry.js`, `vidu.js`, `waterMark.js`, `watermarks.js`) that are tightly coupled to Telegram bots. They expect inbound `msg` objects, call Telegram APIs for file retrieval, and return media via bot helpers.  

The new **StationThis** platform replaces ad-hoc command files with declarative **Static Tool Definitions** (see `src/core/tools/definitions/`).  We have already migrated `assist.js` → `chatgpt.js`, demonstrating how runtime logic can be wrapped by a stable tool contract that is consumable by any frontend (web sandbox, CLI, future Slack bot, etc.).

We must perform the same transformation for the remaining media-centric commands while respecting that:
1. They rely on Telegram’s file-hosting & upload flow.
2. The web client will eventually provide equivalent upload endpoints.
3. We do **not** want to drag Telegram SDK dependencies into the core tools package.

## Decision
We will create one **tool definition** per legacy command, exposing a clean API that hides Telegram specifics behind a **gateway micro-service** (`/llm/media/*`).  The pattern:

1. Extract pure processing logic (FFmpeg, Jimp, API fetches) into **service modules** under `src/services/legacyMedia/` that take primitive inputs (file URLs, text, params) and return processed buffers / URLs.
2. Build **adapter endpoints** in `server/media-gateway/` that:  
   • Accept multipart uploads or external URLs  
   • Call the service modules  
   • Stream back the result.  
   These endpoints will also be callable from the Telegram bot to maintain backward compatibility during transition.
3. Register **ToolDefinition** JSON for each service (`/brandcast`, `/frythat`, etc.) in `src/core/tools/definitions/`, similar to `chatgpt.js`.  Each definition will include:
   • `toolId`, `displayName`, `commandName`  
   • `apiPath` pointing to the new gateway route  
   • Input / output schemas describing required files or parameters  
   • Costing model (static per invocation until tokenised metrics exist).
4. Deprecate direct usage in the Telegram command registry.  The bot will instead perform an HTTP call to the gateway, then forward the response to the user.  This keeps a single source of truth for media processing.
5. Move watermark configuration (`watermarks.js`) to `config/watermarks.json` so both gateway and bot can import it.

## Alternatives Considered
*Fork the existing command files into the core tools package.*  
Rejected: would duplicate Telegram-specific code and violate separation of concerns.

*Keep commands Telegram-only and expose no tool.*  
Rejected: contradicts refactor north star of platform-agnostic tools.

*Monolith approach – call FFmpeg/Jimp directly inside the ToolDefinition server-side handler.*  
Rejected: tight coupling; gateway pattern offers clearer boundary and easier scaling.

## Consequences
Positive:
• All media tools become first-class citizens in the StationThis ecosystem, usable from web sandbox and future clients.  
• Telegram bot becomes thinner and easier to maintain.  
• Centralised costing & metrics.

Negative / Risks:
• Requires building and deploying the media-gateway service.  
• Upload semantics differ between Telegram and HTTP; need extra work in the web UI.  
• Latency may increase due to additional HTTP hop.

## Implementation Log
*2025-08-23 – ADR drafted (auto-generated by AI assistant).*  
*TODO: Link to sprint when work begins.  Update log with progress, blockers, and decisions.*
