> Imported from vibecode/bulk/docs/05-15-25-SPRINT.md on 2025-08-21

# SPRINT-2025-05-ToolRegistry.md

## 🎯 Sprint Objective

Migrate ComfyUI workflow discovery into the new ToolRegistry system as defined in `ADR-009-Tool_Definition_and_Registry.md`.

This sprint aims to make all ComfyUI tools available in a central, queryable registry to support platform command generation, costing, documentation, and agent UX.

---

## 📅 Timeline

- **Start:** 2025-05-15  
- **Target End:** TBD (based on scope drift)

---

## 📦 Related Documents

- ADR: `ADR-009-Tool_Definition_and_Registry.md`
- Plan: `PLAN-ComfyUI-ToolRegistry-Migration.md`
- Meta Prompts:
  - `meta/tool-def-builder.md`
  - `meta/cache-to-registry.md`
  - etc.

---

## 🛠️ Tasks

| Task | Owner | Status | Notes |
|------|-------|--------|-------|
| Create `ToolDefinition`/`ToolRegistry` primitives | Agent | ✅ | Implemented as per Step 1 of PLAN-ComfyUI-ToolRegistry-Migration.md. Files created: `src/core/tools/ToolDefinition.js`, `src/core/tools/ToolRegistry.js` (converted from .ts). |
| Hook into `WorkflowCacheManager` | Agent | ✅ | Done (Steps 3 & 4 of plan). `workflowCacheManager.js` modified to create `ToolDefinition` objects from workflows and register them into `ToolRegistry`. Added `extractNotes` to `workflowUtils.js`. |
| Extract `Note` node as description | Agent | ✅ | Done as part of `workflowCacheManager` integration. `workflowUtils.extractNotes()` created and used. |
| Populate `inputSchema`, `costingModel`, `platformHints` | Agent | ✅ | `inputSchema` and `platformHints` population significantly improved by leveraging `parseWorkflowStructure` in `workflowUtils.js` and refining logic in `createToolDefinitionFromWorkflow` within `workflowCacheManager.js`. This leads to more accurate determination of required inputs, input types, default values, and platform-appropriate hints. `costingModel` continues to be populated based on machine GPU types. `WorkflowsService` methods correctly use `ToolDefinition.inputSchema`. While much improved, further refinement for edge cases or more complex workflow scenarios may be beneficial in the future. |
| Register tool into `ToolRegistry` | Agent | ✅ | Done (Step 4 of plan). `ToolDefinition` objects are registered into `ToolRegistry` from `workflowCacheManager.js`. |
| Add `validate()` function to registry | Agent | ✅ | Done (Step 5 of plan). Implemented a comprehensive `validate()` method in `ToolRegistry.js`. |
| Create flash script (`tools/flashToolRegistry.js`) | Agent | ✅ | Done (Step 6 of plan). Created `tools/flashToolRegistry.js` script to serialize registry. |
| Refactor `WorkflowsService` to use `ToolRegistry` | Agent | ✅ | Done. `WorkflowsService` now uses `ToolRegistry` and `ToolDefinition` for methods like `getToolRequiredInputs`, `validateToolInputPayload`, `mergeToolWithDefaultInputs`, and `prepareToolRunPayload`. |
| Refactor platform usage (Web Routes) | Agent | ✅ | Done. `src/platforms/web/routes/index.js` dynamic tool routes now use the refactored `WorkflowsService` and `prepareToolRunPayload`. |
| Refactor platform usage (Telegram) | Agent | 🟡 | In progress. `dynamicCommands.js` now uses `ToolRegistry` via `WorkflowsService`. Command classification logic significantly improved. Text-only and Image-based (replying to image with URL) command execution path implemented for all 23 classified ComfyUI tools. Next: Testing, potential video input handling. |

---

## 🧠 Observations

> _Use this section to jot down architectural decisions, blockers, surprises, or naming ideas._

---

## ✅ Completion Criteria

See [plan doc](../audits/PLAN-ComfyUI-ToolRegistry-Migration.md#4-completion-criteria)